<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      #map-canvas {
        width: 800px;
        height: 600px;
      }

      #loading {
        display: none;

        position: absolute;
        top:0; left: 0;
        z-index: 9999;

        text-align: center;
        width: 100%;

      }
        #loading-content {
          width:150px;
          margin:20% auto;

          padding: 20px;
          text-align: center;

          background: rgba(0,0,0, .15);

          -webkit-box-shadow: 0 0 9999px 9999px rgba(0, 0, 0, 0.5);
          -moz-box-shadow: 0 0 9999px 9999px rgba(0, 0, 0, 0.5);
          box-shadow: 0 0 9999px 9999px rgba(0, 0, 0, 0.5);

          -webkit-border-radius: 15px;
          -moz-border-radius: 15px;
          border-radius: 15px;
        }
    </style>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="../handlebars.js"></script>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxTEbJsXwGRW4zDj8fpVsenDMMQGhZhUU&sensor=false">
    </script>
    <script data-main="../initialize" src="../../externals/require.js"></script>
    <script type="text/javascript">
      var monthMap = [
        'Jan',
        'Feb',
        'Mar',
        'Apr',
        'May',
        'June',
        'July',
        'Aug',
        'Sept',
        'Oct',
        'Nov',
        'Dec'
      ];

      /**
       * Converts a timestamp or ISO string to javscript Date object
       *
       * @param {Number|Date|string} timestampOrISO A timestamp or ISO string
       * @returns {Date}
       */
      function getDate(timestampOrISO) {
        var date;
        switch($.type(timestampOrISO)) {
          case 'number':
            // assume timestamp
            date = new Date(timestampOrISO * 1000);
            break;
          case 'date':
            break;
          case 'string':
            // assume ISO.
            // Could check with regex, but this is more simple for now
            date = new Date(timestampOrISO)
            break;
          default:
            throw new Error("Cannot normalize date: invalid timestampOrISO argument type");
        }
        return date;
      }


      /**
       * Returns a formatted time (eg. "3:45 PM")
       *
       * @param {Date|number|string} date Can be timestamp, {Date}, or ISO {string}
       * @return {string} Formatted time
       */
      Handlebars.registerHelper('formatTime', function(time) {
        var hours, minutes, ampm, date;

        if(!time) {
          return "-";
        }

        date = getDate(time);

        minutes = date.getMinutes();
        minutes = minutes < 10 ? minutes = "0" + minutes: minutes;

        hours = date.getHours();
        ampm = "AM";
        if(hours >= 12) {
          hours -= 12;
          ampm = "PM";
        }
        if(hours === 0) {
          hours = 12
        }


        return hours + ':' + minutes + ' ' + ampm;
      });


      /**
       * Returns a formatted date (eg. "Aug 21, 2013")
       *
       * @param {Date|number|string} date Can be timestamp, {Date}, or ISO {string}
       * @return {string} Formatted date
       */
      Handlebars.registerHelper('formatDate', function(time) {
        var date;

        if(!time) {
          return '-';
        }

        date = getDate(time);

        return monthMap[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();
      });


      /**
       * Return a the string with all words capitalized
       *
       * @param {string} string
       * @returns {string} Capitalized string.
       */
      Handlebars.registerHelper('capitalizeWords', function(string) {
        if(!string) {
          return '-';
        }

        if(toString.call(string) !== '[object String]') {
          throw new Error('Invalid argument: string');
        }
        return string.replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); });
      });


      /**
       * Converts a string to all uppercase letters
       *
       * @param {string} string
       * @return {string} Uppercase string
       */
      Handlebars.registerHelper('uppercase', function(string) {
        return string.toUpperCase();
      });


      function initialize() {
        require.config({
          config: {
            aeris: {
              apiId: 'ezHWL0MiLsxwlN2ik8U4c',
              apiSecret: 'uCDMeSj91lBfIKCmeQkpeZjsAwUUQJHuKesCvqTm'
            }
          }
        });
        require(['aeris/maps/gmaps', 'base/markercollections/firemarkers'], function(aeris, FireMarkers) {
          var $loading = $('#loading');
          $loading.show();

          var map = new aeris.maps.gmaps.Map('map-canvas', {
            baseLayer: new aeris.maps.layers.GoogleRoadMap(),
            center: [44.98, -93.2636],
            zoom: 4
          });

          var fireData = new FireMarkers();

          var templatePromise = $.ajax({
            url: 'fire-details.handlebars',
            cache: true,
            success: function(data) {
              source = data;
              template = Handlebars.compile(source);
            }
          });

          // Prevent choppy 'loading' UI
          var loadingTimeout = (function() {
            var promise = $.Deferred();
            window.setTimeout(function() {
              promise.resolve();
            }, 1000)
            return promise;
          })();


          var handleMarkerClick = function(marker, data) {
            var html = template(data);
            var infoBox = new aeris.maps.layers.InfoBox(marker.position, html);
            infoBox.setMap(map);
          };

          // Add the fire marker collection to the map
          fireData.setMap(map);

          // Wait for everything to be ready to bind click event
          $.when(fireData.initialized, map.initialized, templatePromise, loadingTimeout).
            done(function() {
              $loading.fadeOut(400);
              fireData.on('marker:click', handleMarkerClick);
            }).
            fail(function() {
              console.log('Something went horribly wrong.', arguments)
            });
        });
      }
    </script>
  </head>
  <body>
    <div id="loading">
      <div id="loading-content"><h3>Loading...</h3></div>
    </div>
    <div id="map-canvas"></div>
  </body>
</html>
